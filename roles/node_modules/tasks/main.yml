---
- name: npm がインストールされているか確認
  shell: command -v npm
  register: npm_check
  ignore_errors: true
  changed_when: false

# エラーメッセージ
- name: npm が見つからない場合は処理を中止
  fail:
    msg: "npm がインストールされていません。先に Node.js をインストールしてください。"
  when: npm_check.rc != 0

- name: pnpm を Volta でインストール
  shell: volta install pnpm
  register: pnpm_install
  changed_when: "'installed' in pnpm_install.stdout"
  failed_when: false

- name: pnpm のセットアップ（グローバル bin ディレクトリ設定）
  shell: pnpm setup
  register: pnpm_setup
  changed_when: "'Appended' in pnpm_setup.stdout"
  failed_when: false

# Ansible の現在のシェルセッションには pnpm のセットアップが反映されないため、直接取得
- name: PNPM_HOME 環境変数を取得
  shell: echo "$HOME/.local/share/pnpm"
  register: pnpm_home_path
  changed_when: false

- name: npm グローバルパッケージをインストール
  shell: npm i -g {{ item }}
  loop:
    - firebase-tools

- name: pnpm グローバルパッケージをインストール
  shell: pnpm i -g {{ item }}
  loop:
    - "@angular/cli"
    - vercel
  environment:
    PNPM_HOME: "{{ pnpm_home_path.stdout }}"
    PATH: "{{ pnpm_home_path.stdout }}:{{ ansible_env.PATH }}"
  become: false
